<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assigned Tasks - MDC TTS</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cairo:wght@400;600;700&family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/transactions.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/grid-view.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Left Section -->
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-link text-dark p-0 d-lg-none" id="sidebarToggle">
                        <i class="bi bi-list fs-4"></i>
                    </button>
                    <div class="logo">
                        <img src="MDC-logo-Black.png" alt="MDC Logo" height="40">
                    </div>
                    <h1 class="h5 mb-0 text-muted d-none d-md-block">Transaction Tracking System</h1>
                </div>
                
                <!-- Right Section -->
                <div class="d-flex align-items-center gap-3">
                    <!-- Search -->
                    <div class="search-box d-none d-md-block">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 bg-transparent" placeholder="Search tasks...">
                        </div>
                    </div>
                    
                    <!-- Notifications -->
                    <button class="btn btn-link text-dark p-2 position-relative">
                        <i class="bi bi-bell fs-5"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                            3
                        </span>
                    </button>
                    
                    <!-- Language Toggle -->
                    <div class="language-toggle">
                        <button class="btn btn-sm btn-outline-secondary" data-lang="en">EN</button>
                        <button class="btn btn-sm btn-outline-secondary active" data-lang="ar">AR</button>
                    </div>
                    
                    <!-- User Menu -->
                    <div class="dropdown">
                        <button class="btn btn-link text-dark p-0 d-flex align-items-center gap-2" data-bs-toggle="dropdown">
                            <div class="user-avatar">
                                <i class="bi bi-person-circle fs-3"></i>
                            </div>
                            <div class="text-start d-none d-lg-block">
                                <div class="fw-semibold" id="userName">Editor User</div>
                                <small class="text-muted" id="userRole">Editor</small>
                            </div>
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="index.html"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="layout-wrapper">
        <!-- Sidebar will be inserted here by sidebar.js -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid p-4">
                <!-- Page Header -->
                <div class="page-header mb-4">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="page-title" data-original-text="Assigned Tasks">المعاملات المسندة</h2>
                            <p class="text-muted mb-0" data-original-text="Manage and track your assigned transactions and tasks">إدارة وتتبع المعاملات والمهام المسندة إليك</p>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex gap-2">
                                <div class="dropdown">
                                    <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="bi bi-funnel me-1"></i> <span data-original-text="Filter">Filter</span>
                                    </button>
                                    <div class="dropdown-menu">
                                        <h6 class="dropdown-header" data-original-text="Filter by Priority">Filter by Priority</h6>
                                        <div class="form-check dropdown-item-text">
                                            <input class="form-check-input" type="checkbox" value="urgent" id="filterUrgent">
                                            <label class="form-check-label" for="filterUrgent" data-original-text="Urgent">Urgent</label>
                                        </div>
                                        <div class="form-check dropdown-item-text">
                                            <input class="form-check-input" type="checkbox" value="high" id="filterHigh">
                                            <label class="form-check-label" for="filterHigh" data-original-text="High">High</label>
                                        </div>
                                        <div class="form-check dropdown-item-text">
                                            <input class="form-check-input" type="checkbox" value="medium" id="filterMedium">
                                            <label class="form-check-label" for="filterMedium" data-original-text="Medium">Medium</label>
                                        </div>
                                        <div class="dropdown-divider"></div>
                                        <h6 class="dropdown-header" data-original-text="Filter by Status">Filter by Status</h6>
                                        <div class="form-check dropdown-item-text">
                                            <input class="form-check-input" type="checkbox" value="pending" id="filterPending">
                                            <label class="form-check-label" for="filterPending" data-original-text="Pending">Pending</label>
                                        </div>
                                        <div class="form-check dropdown-item-text">
                                            <input class="form-check-input" type="checkbox" value="in-progress" id="filterInProgress">
                                            <label class="form-check-label" for="filterInProgress" data-original-text="In Progress">In Progress</label>
                                        </div>
                                        <div class="dropdown-divider"></div>
                                        <button class="dropdown-item btn btn-sm btn-primary" onclick="applyFilters()">
                                            <i class="bi bi-check me-1"></i> <span data-original-text="Apply">Apply</span>
                                        </button>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary" onclick="exportTasks()">
                                    <i class="bi bi-download me-1"></i> <span data-original-text="Export">Export</span>
                                </button>
                                <button class="btn btn-outline-success" onclick="bulkUpdate()">
                                    <i class="bi bi-check-all me-1"></i> <span data-original-text="Bulk Update">Bulk Update</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-primary-subtle">
                                <i class="bi bi-list-task text-primary"></i>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-value" id="totalTasks">12</h3>
                                <p class="stat-label" data-original-text="Total Assigned">إجمالي المسند</p>
                                <span class="stat-change text-info">
                                    <i class="bi bi-info-circle"></i> <span data-original-text="Active tasks">المهام النشطة</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-danger-subtle">
                                <i class="bi bi-exclamation-triangle text-danger"></i>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-value text-danger" id="urgentTasks">3</h3>
                                <p class="stat-label" data-original-text="Urgent">Urgent</p>
                                <span class="stat-change text-danger">
                                    <i class="bi bi-clock"></i> <span data-original-text="Due today">مستحقة اليوم</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-warning-subtle">
                                <i class="bi bi-hourglass-split text-warning"></i>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-value text-warning" id="pendingTasks">5</h3>
                                <p class="stat-label" data-original-text="Pending Review">Pending Review</p>
                                <span class="stat-change text-muted">
                                    <i class="bi bi-eye"></i> <span data-original-text="Awaiting action">في انتظار إجراء</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-success-subtle">
                                <i class="bi bi-check-circle text-success"></i>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-value text-success" id="completedTasks">4</h3>
                                <p class="stat-label" data-original-text="In Progress">In Progress</p>
                                <span class="stat-change text-success">
                                    <i class="bi bi-arrow-right"></i> <span data-original-text="On track">على المسار الصحيح</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Filters & Search -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-12 col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="searchTasks" placeholder="Search by ID, client, or description..." data-original-text="Search by ID, client, or description...">
                                </div>
                            </div>
                            <div class="col-6 col-md-2">
                                <select class="form-select" id="priorityFilter">
                                    <option value="" data-original-text="All Priorities">All Priorities</option>
                                    <option value="urgent" data-original-text="Urgent">Urgent</option>
                                    <option value="high" data-original-text="High">High</option>
                                    <option value="medium" data-original-text="Medium">Medium</option>
                                    <option value="low" data-original-text="Low">Low</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-2">
                                <select class="form-select" id="statusFilter">
                                    <option value="" data-original-text="All Status">All Status</option>
                                    <option value="pending" data-original-text="Pending">Pending</option>
                                    <option value="in-progress" data-original-text="In Progress">In Progress</option>
                                    <option value="review" data-original-text="Under Review">قيد المراجعة</option>
                                    <option value="completed" data-original-text="Completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-2">
                                <select class="form-select" id="dueDateFilter">
                                    <option value="" data-original-text="All Due Dates">All Due Dates</option>
                                    <option value="overdue" data-original-text="Overdue">Overdue</option>
                                    <option value="today" data-original-text="Due Today">Due Today</option>
                                    <option value="week" data-original-text="This Week">This Week</option>
                                    <option value="month" data-original-text="This Month">This Month</option>
                                </select>
                            </div>
                            <div class="col-6 col-md-2">
                                <button class="btn btn-primary w-100" onclick="applyQuickFilters()">
                                    <i class="bi bi-funnel me-1"></i> <span data-original-text="Filter">Filter</span>
                                </button>
                            </div>
                        </div>
                        <!-- Active Filters Display -->
                        <div class="row mt-3" id="activeFiltersRow" style="display: none;">
                            <div class="col-12">
                                <div class="d-flex gap-2 flex-wrap align-items-center">
                                    <span class="small text-muted me-2" data-original-text="Active filters:">Active filters:</span>
                                    <div id="activeFilterTags"></div>
                                    <button class="btn btn-sm btn-outline-danger ms-auto" onclick="clearAllFilters()">
                                        <i class="bi bi-x-circle me-1"></i> <span data-original-text="Clear All">Clear All</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assigned Tasks Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <div class="form-check d-inline-block me-3">
                                <input class="form-check-input" type="checkbox" id="selectAllTasks">
                                <label class="form-check-label" for="selectAllTasks">
                                    <span class="text-muted small" data-original-text="Select All">Select All</span>
                                </label>
                            </div>
                            <span class="text-muted" data-original-text="Showing">Showing</span>
                            <select class="form-select form-select-sm d-inline-block mx-2" style="width: auto;" id="pageSize">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                            </select>
                            <span class="text-muted" data-original-text="of">of</span>
                            <span class="fw-semibold" id="totalTasksCount">12</span>
                            <span class="text-muted" data-original-text="tasks">tasks</span>
                        </div>
                        <div class="d-flex gap-2">
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-secondary" onclick="markSelectedAs('completed')" title="Mark as Complete" data-original-title="Mark as Complete">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="markSelectedAs('in-progress')" title="Mark as In Progress" data-original-title="Mark as In Progress">
                                    <i class="bi bi-play-circle"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="assignSelected()" title="Reassign Selected" data-original-title="Reassign Selected">
                                    <i class="bi bi-person-plus"></i>
                                </button>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshTasks()" title="Refresh" data-original-title="Refresh">
                                <i class="bi bi-arrow-clockwise"></i>
                                <span class="d-none d-sm-inline ms-1" data-original-text="Refresh">Refresh</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-mobile-card mb-0" id="assignedTasksTable">
                                <thead>
                                    <tr>
                                        <th width="40">
                                            <input type="checkbox" class="form-check-input" id="selectAllHeader">
                                        </th>
                                        <th class="sortable" data-sort="priority">
                                            <span data-original-text="Priority">Priority</span> <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="sortable" data-sort="reference-number">
                                            <span data-original-text="Reference Number">الرقم المرجعي</span> <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="sortable" data-sort="transaction-id">
                                            <span data-original-text="Transaction ID">Transaction ID</span> <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="sortable" data-sort="client">
                                            <span data-original-text="Client">Client</span> <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="sortable" data-sort="type">
                                            <span data-original-text="Type">Type</span> <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="sortable" data-sort="description" class="d-none d-lg-table-cell">
                                            <span data-original-text="Description">Description</span> <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="sortable" data-sort="status">
                                            <span data-original-text="Status">Status</span> <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="sortable" data-sort="assigned-date" class="d-none d-md-table-cell">
                                            <span data-original-text="Assigned">Assigned</span> <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="sortable" data-sort="due-date">
                                            <span data-original-text="Due Date">Due Date</span> <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="d-none d-lg-table-cell">
                                            <span data-original-text="Progress">Progress</span>
                                        </th>
                                        <th width="60">
                                            <span data-original-text="Actions">الإجراءات</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="tasksTableBody">
                                    <!-- Tasks will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row align-items-center">
                            <div class="col">
                                <p class="text-muted mb-0">
                                    <span data-original-text="Showing">Showing</span>
                                    <span id="showingFrom">1</span>
                                    <span data-original-text="to">to</span>
                                    <span id="showingTo">12</span>
                                    <span data-original-text="of">of</span>
                                    <span id="totalEntries">12</span>
                                    <span data-original-text="tasks">tasks</span>
                                </p>
                            </div>
                            <div class="col-auto">
                                <nav>
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1" data-original-text="Previous">Previous</a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#" data-original-text="Next">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal fade" id="taskDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-original-text="Task Details">Task Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="taskDetailContent">
                    <!-- Task details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="updateTaskStatus()">
                        <i class="bi bi-pencil me-1"></i> <span data-original-text="Update Status">Update Status</span>
                    </button>
                    <button type="button" class="btn btn-primary" onclick="completeTask()">
                        <i class="bi bi-check-circle me-1"></i> <span data-original-text="Mark Complete">Mark Complete</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusUpdateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-original-text="Update Task Status">Update Task Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="statusUpdateForm">
                        <div class="mb-3">
                            <label class="form-label" data-original-text="New Status">New Status</label>
                            <select class="form-select" id="newStatus" required>
                                <option value="pending" data-original-text="Pending Review">Pending Review</option>
                                <option value="in-progress" data-original-text="In Progress">In Progress</option>
                                <option value="review" data-original-text="Under Review">Under Review</option>
                                <option value="completed" data-original-text="Completed">Completed</option>
                                <option value="on-hold" data-original-text="On Hold">On Hold</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-original-text="Comments">Comments</label>
                            <textarea class="form-control" id="statusComment" rows="3" placeholder="Add any comments about this status change..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-original-text="Cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStatusUpdate()">
                        <i class="bi bi-check me-1"></i> <span data-original-text="Update Status">Update Status</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Dashboard JS -->
    <script src="js/translations.js"></script>
    <script src="js/sidebar.js?v=4.0"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/assigned-tasks.js"></script>

    <script>
        // Sample task data
        const sampleTasks = [
            {
                id: 'TRX-2024-001',
                externalId: 'DOC-2024-006',
                client: 'Ahmed Al-Rashid',
                type: 'Document Review',
                description: 'Technical specifications review for building permit',
                status: 'pending',
                priority: 'urgent',
                assignedDate: '2024-01-15',
                dueDate: '2024-01-16',
                progress: 25,
                comments: 2,
                attachments: 3
            },
            {
                id: 'TRX-2024-002',
                externalId: 'APR-2024-007',
                client: 'Fatima Al-Zahrani',
                type: 'Approval Processing',
                description: 'Design approval workflow for commercial project',
                status: 'in-progress',
                priority: 'urgent',
                assignedDate: '2024-01-15',
                dueDate: '2024-01-16',
                progress: 60,
                comments: 1,
                attachments: 5
            },
            {
                id: 'TRX-2024-003',
                externalId: 'UPL-2024-008',
                client: 'Mohammed Al-Qahtani',
                type: 'Document Upload',
                description: 'Site survey documents processing',
                status: 'review',
                priority: 'high',
                assignedDate: '2024-01-14',
                dueDate: '2024-01-17',
                progress: 40,
                comments: 0,
                attachments: 2
            },
            {
                id: 'TRX-2024-004',
                externalId: 'STA-2024-009',
                client: 'Sara Al-Mutairi',
                type: 'Status Update',
                description: 'Project milestone update and documentation',
                status: 'pending',
                priority: 'medium',
                assignedDate: '2024-01-13',
                dueDate: '2024-01-18',
                progress: 10,
                comments: 3,
                attachments: 1
            },
            {
                id: 'TRX-2024-005',
                externalId: 'REQ-2024-010',
                client: 'Abdullah Al-Dosari',
                type: 'Requirements Gathering',
                description: 'Client requirements document compilation',
                status: 'in-progress',
                priority: 'medium',
                assignedDate: '2024-01-12',
                dueDate: '2024-01-19',
                progress: 75,
                comments: 5,
                attachments: 4
            }
        ];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadTasksTable();
            initializeFilters();
            updateSummaryCards();
        });

        function loadTasksTable() {
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = '';

            sampleTasks.forEach(task => {
                const row = createTaskRow(task);
                tbody.appendChild(row);
            });
        }

        function createTaskRow(task) {
            const tr = document.createElement('tr');
            tr.dataset.taskId = task.id;
            
            const priorityClass = getPriorityClass(task.priority);
            const statusClass = getStatusClass(task.status);
            const dueDateClass = getDueDateClass(task.dueDate);
            
            const referenceNumber = task.externalId || `REF-${task.id.replace('TRX-', '')}`;
            
            tr.innerHTML = `
                <td>
                    <input type="checkbox" class="form-check-input task-checkbox" value="${task.id}">
                </td>
                <td>
                    <span class="badge ${priorityClass}">${capitalizeFirst(task.priority)}</span>
                </td>
                <td>
                    <div class="fw-semibold text-primary">${referenceNumber}</div>
                </td>
                <td>
                    <div class="fw-semibold">${task.id}</div>
                    <small class="text-muted">${task.externalId}</small>
                </td>
                <td class="fw-medium">${task.client}</td>
                <td>${task.type}</td>
                <td class="d-none d-lg-table-cell">
                    <span class="text-truncate d-inline-block" style="max-width: 200px;" title="${task.description}">
                        ${task.description}
                    </span>
                </td>
                <td>
                    <span class="badge ${statusClass}">${getStatusLabel(task.status)}</span>
                </td>
                <td class="d-none d-md-table-cell">
                    <small>${formatDate(task.assignedDate)}</small>
                </td>
                <td>
                    <span class="${dueDateClass}">${formatDate(task.dueDate)}</span>
                    ${isOverdue(task.dueDate) ? '<i class="bi bi-exclamation-triangle text-danger ms-1"></i>' : ''}
                </td>
                <td class="d-none d-lg-table-cell">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar ${task.progress < 30 ? 'bg-danger' : task.progress < 70 ? 'bg-warning' : 'bg-success'}" 
                             style="width: ${task.progress}%"></div>
                    </div>
                    <small class="text-muted">${task.progress}%</small>
                </td>
                <td>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" href="#" onclick="viewTaskDetails('${task.id}'); return false;">
                                    <i class="bi bi-eye me-2"></i>
                                    <span data-original-text="View Details">عرض التفاصيل</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="quickStatusUpdate('${task.id}', 'in-progress'); return false;">
                                    <i class="bi bi-play me-2"></i>
                                    <span data-original-text="Start Task">بدء المهمة</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="openStatusModal('${task.id}'); return false;">
                                    <i class="bi bi-pencil me-2"></i>
                                    <span data-original-text="Update Status">تحديث الحالة</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </td>
            `;
            
            return tr;
        }

        function getPriorityClass(priority) {
            const classes = {
                'urgent': 'bg-danger',
                'high': 'bg-warning text-dark',
                'medium': 'bg-info',
                'low': 'bg-secondary'
            };
            return classes[priority] || 'bg-secondary';
        }

        function getStatusClass(status) {
            const classes = {
                'pending': 'bg-warning text-dark',
                'in-progress': 'bg-primary',
                'review': 'bg-info',
                'completed': 'bg-success',
                'on-hold': 'bg-secondary'
            };
            return classes[status] || 'bg-secondary';
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pending Review',
                'in-progress': 'In Progress',
                'review': 'Under Review',
                'completed': 'Completed',
                'on-hold': 'On Hold'
            };
            return labels[status] || status;
        }

        function getDueDateClass(dueDate) {
            if (isOverdue(dueDate)) return 'text-danger fw-bold';
            if (isDueToday(dueDate)) return 'text-warning fw-semibold';
            return '';
        }

        function isOverdue(dueDate) {
            return new Date(dueDate) < new Date();
        }

        function isDueToday(dueDate) {
            const today = new Date();
            const due = new Date(dueDate);
            return today.toDateString() === due.toDateString();
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function updateSummaryCards() {
            document.getElementById('totalTasks').textContent = sampleTasks.length;
            document.getElementById('urgentTasks').textContent = sampleTasks.filter(t => t.priority === 'urgent').length;
            document.getElementById('pendingTasks').textContent = sampleTasks.filter(t => t.status === 'pending').length;
            document.getElementById('completedTasks').textContent = sampleTasks.filter(t => t.status === 'in-progress').length;
        }

        function initializeFilters() {
            // Initialize filter event listeners
            document.getElementById('searchTasks').addEventListener('input', applyQuickFilters);
            document.getElementById('priorityFilter').addEventListener('change', applyQuickFilters);
            document.getElementById('statusFilter').addEventListener('change', applyQuickFilters);
            document.getElementById('dueDateFilter').addEventListener('change', applyQuickFilters);
        }

        function applyQuickFilters() {
            const searchTerm = document.getElementById('searchTasks').value.toLowerCase();
            const priorityFilter = document.getElementById('priorityFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const dueDateFilter = document.getElementById('dueDateFilter').value;

            const rows = document.querySelectorAll('#tasksTableBody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const task = sampleTasks.find(t => t.id === row.dataset.taskId);
                if (!task) return;

                let visible = true;

                // Apply search filter
                if (searchTerm && !task.id.toLowerCase().includes(searchTerm) && 
                    !task.client.toLowerCase().includes(searchTerm) &&
                    !task.description.toLowerCase().includes(searchTerm)) {
                    visible = false;
                }

                // Apply priority filter
                if (priorityFilter && task.priority !== priorityFilter) {
                    visible = false;
                }

                // Apply status filter
                if (statusFilter && task.status !== statusFilter) {
                    visible = false;
                }

                // Apply due date filter
                if (dueDateFilter) {
                    const dueDate = new Date(task.dueDate);
                    const today = new Date();
                    
                    switch(dueDateFilter) {
                        case 'overdue':
                            if (dueDate >= today) visible = false;
                            break;
                        case 'today':
                            if (!isDueToday(task.dueDate)) visible = false;
                            break;
                        case 'week':
                            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                            if (dueDate < today || dueDate > weekFromNow) visible = false;
                            break;
                        case 'month':
                            const monthFromNow = new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
                            if (dueDate < today || dueDate > monthFromNow) visible = false;
                            break;
                    }
                }

                row.style.display = visible ? '' : 'none';
                if (visible) visibleCount++;
            });

            // Update counts
            document.getElementById('totalTasksCount').textContent = visibleCount;
            document.getElementById('showingTo').textContent = Math.min(visibleCount, 25);
            document.getElementById('totalEntries').textContent = visibleCount;

            // Show active filters
            updateActiveFilters(searchTerm, priorityFilter, statusFilter, dueDateFilter);
        }

        function updateActiveFilters(search, priority, status, dueDate) {
            const activeFiltersRow = document.getElementById('activeFiltersRow');
            const activeFilterTags = document.getElementById('activeFilterTags');
            
            let hasFilters = false;
            let tagsHtml = '';

            if (search) {
                tagsHtml += `<span class="badge bg-light text-dark border me-1">Search: "${search}" <button type="button" class="btn-close btn-close-sm ms-1" onclick="clearFilter('search')"></button></span>`;
                hasFilters = true;
            }
            if (priority) {
                tagsHtml += `<span class="badge bg-light text-dark border me-1">Priority: ${capitalizeFirst(priority)} <button type="button" class="btn-close btn-close-sm ms-1" onclick="clearFilter('priority')"></button></span>`;
                hasFilters = true;
            }
            if (status) {
                tagsHtml += `<span class="badge bg-light text-dark border me-1">Status: ${getStatusLabel(status)} <button type="button" class="btn-close btn-close-sm ms-1" onclick="clearFilter('status')"></button></span>`;
                hasFilters = true;
            }
            if (dueDate) {
                tagsHtml += `<span class="badge bg-light text-dark border me-1">Due: ${capitalizeFirst(dueDate)} <button type="button" class="btn-close btn-close-sm ms-1" onclick="clearFilter('dueDate')"></button></span>`;
                hasFilters = true;
            }

            activeFilterTags.innerHTML = tagsHtml;
            activeFiltersRow.style.display = hasFilters ? '' : 'none';
        }

        function clearFilter(type) {
            switch(type) {
                case 'search':
                    document.getElementById('searchTasks').value = '';
                    break;
                case 'priority':
                    document.getElementById('priorityFilter').value = '';
                    break;
                case 'status':
                    document.getElementById('statusFilter').value = '';
                    break;
                case 'dueDate':
                    document.getElementById('dueDateFilter').value = '';
                    break;
            }
            applyQuickFilters();
        }

        function clearAllFilters() {
            document.getElementById('searchTasks').value = '';
            document.getElementById('priorityFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dueDateFilter').value = '';
            applyQuickFilters();
        }

        function viewTaskDetails(taskId) {
            const task = sampleTasks.find(t => t.id === taskId);
            if (!task) return;

            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            const content = document.getElementById('taskDetailContent');
            
            content.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <strong>Transaction ID:</strong><br>
                        <span class="text-muted">${task.id}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Reference Number:</strong><br>
                        <span class="text-muted">${task.externalId}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Client:</strong><br>
                        <span class="text-muted">${task.client}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Type:</strong><br>
                        <span class="text-muted">${task.type}</span>
                    </div>
                    <div class="col-12">
                        <strong>Description:</strong><br>
                        <span class="text-muted">${task.description}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Priority:</strong><br>
                        <span class="badge ${getPriorityClass(task.priority)}">${capitalizeFirst(task.priority)}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Status:</strong><br>
                        <span class="badge ${getStatusClass(task.status)}">${getStatusLabel(task.status)}</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Progress:</strong><br>
                        <div class="progress mt-1" style="height: 10px;">
                            <div class="progress-bar ${task.progress < 30 ? 'bg-danger' : task.progress < 70 ? 'bg-warning' : 'bg-success'}" 
                                 style="width: ${task.progress}%"></div>
                        </div>
                        <small class="text-muted">${task.progress}%</small>
                    </div>
                    <div class="col-md-6">
                        <strong>Assigned Date:</strong><br>
                        <span class="text-muted">${formatDate(task.assignedDate)}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Due Date:</strong><br>
                        <span class="text-muted ${getDueDateClass(task.dueDate)}">${formatDate(task.dueDate)}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Comments:</strong><br>
                        <span class="text-muted">${task.comments} comments</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Attachments:</strong><br>
                        <span class="text-muted">${task.attachments} files</span>
                    </div>
                </div>
            `;
            
            modal.show();
        }

        function openStatusModal(taskId) {
            const modal = new bootstrap.Modal(document.getElementById('statusUpdateModal'));
            modal._taskId = taskId;
            modal.show();
        }

        function saveStatusUpdate() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal'));
            const taskId = modal._taskId;
            const newStatus = document.getElementById('newStatus').value;
            const comment = document.getElementById('statusComment').value;
            
            // Here you would typically make an API call to update the task
            console.log('Updating task:', taskId, 'to status:', newStatus, 'with comment:', comment);
            
            // For demo, update the task in memory and refresh table
            const task = sampleTasks.find(t => t.id === taskId);
            if (task) {
                task.status = newStatus;
                loadTasksTable();
                updateSummaryCards();
            }
            
            modal.hide();
            
            // Show success message
            showNotification('Task status updated successfully!', 'success');
        }

        function quickStatusUpdate(taskId, status) {
            const task = sampleTasks.find(t => t.id === taskId);
            if (task) {
                task.status = status;
                loadTasksTable();
                updateSummaryCards();
                showNotification(`Task marked as ${getStatusLabel(status)}!`, 'success');
            }
        }

        function markSelectedAs(status) {
            const selectedCheckboxes = document.querySelectorAll('.task-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                showNotification('Please select at least one task to update.', 'warning');
                return;
            }
            
            selectedIds.forEach(taskId => {
                const task = sampleTasks.find(t => t.id === taskId);
                if (task) {
                    task.status = status;
                }
            });
            
            loadTasksTable();
            updateSummaryCards();
            showNotification(`${selectedIds.length} task(s) marked as ${getStatusLabel(status)}!`, 'success');
        }

        function exportTasks() {
            showNotification('Export functionality will be implemented soon.', 'info');
        }

        function bulkUpdate() {
            showNotification('Bulk update functionality will be implemented soon.', 'info');
        }

        function refreshTasks() {
            loadTasksTable();
            updateSummaryCards();
            showNotification('Tasks refreshed successfully!', 'success');
        }

        function showNotification(message, type = 'info') {
            // Simple notification system - in real app this would be more sophisticated
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 100px; right: 20px; z-index: 1050; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Select all functionality
        document.addEventListener('DOMContentLoaded', function() {
            const selectAllCheckboxes = document.querySelectorAll('#selectAllTasks, #selectAllHeader');
            selectAllCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const taskCheckboxes = document.querySelectorAll('.task-checkbox');
                    taskCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });
                    // Update the other select all checkbox
                    selectAllCheckboxes.forEach(cb => {
                        if (cb !== this) cb.checked = this.checked;
                    });
                });
            });
        });
    </script>
</body>
</html>